<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>R-Calculator</title>
<link rel="icon" type="image/png" href="icon.png">
<link rel="apple-touch-icon" href="icon.png">
<link rel="manifest" href="manifest.json">

<!-- Firebase (ONLY CLOUD DB, NO AUTH) -->
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>

<style>
:root{--accent:#007bff;--bg:#f4f6fb;--card:#fff}
*{box-sizing:border-box}
html,body{margin:0;font-family:system-ui;background:var(--bg)}
.wrap{max-width:720px;margin:48px auto;padding:12px}
.card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.06)}
h1{text-align:center}
label{display:block;margin-top:10px;font-weight:600}
select,input,button{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;margin-top:6px}
button{background:var(--accent);color:#fff;border:0;cursor:pointer}
button.secondary{background:#eee;color:#111}
.row{display:flex;gap:8px;margin-top:10px}
.row button{flex:1}
.pair-list{max-height:260px;overflow:auto;border:1px solid #eee;padding:8px;border-radius:8px;background:#fafafa;margin-top:8px}
.pair-item{display:flex;justify-content:space-between;align-items:center;padding:6px;border-bottom:1px solid #eee}
.small-btn{padding:3px 6px;font-size:12px;border-radius:6px;border:0;background:#eee}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55)}
.panel{background:#fff;padding:14px;border-radius:10px;max-width:720px;width:100%}
#lotResult{margin-top:12px;font-weight:700;background:#e8f0ff;padding:8px;border-radius:8px;text-align:center}
</style>
</head>

<body>

<div class="wrap">
  <div class="card">
    <h1>R-Calculator</h1>

    <!-- CALCULATOR -->
    <label>Pair</label>
    <select id="pairSelect"></select>

    <label>Lot Type</label>
    <select id="lotType">
      <option value="standardPoint">Standard Point</option>
      <option value="miniPoint">Mini Point</option>
      <option value="microPoint">Micro Point</option>
      <option value="standardPip">Standard Pip</option>
      <option value="miniPip">Mini Pip</option>
      <option value="microPip">Micro Pip</option>
    </select>

    <label>Risk ($)</label>
    <input id="risk" type="number">

    <label>Stop Loss</label>
    <input id="sl" type="number">

    <div class="row">
      <button onclick="calculateLot()">Calculate</button>
      <button class="secondary" onclick="clearCalc()">Clear</button>
    </div>

    <div id="lotResult" style="display:none"></div>

    <div class="row" style="margin-top:12px">
      <button class="secondary" onclick="openModal()">Add / Edit Pairs</button>
      <button class="secondary" onclick="reloadCloud()">Reload Cloud</button>
    </div>
  </div>
</div>

<!-- PAIR MODAL -->
<div id="modal" class="modal">
  <div class="panel">
    <h3>Manage Pairs</h3>

    <label>Pair</label>
    <input id="editName">

    <label>Point Value</label>
    <input id="editPoint" type="number">

    <label>Pip Value</label>
    <input id="editPip" type="number">

    <label>Commission</label>
    <input id="editCommission" type="number">

    <div class="row">
      <button onclick="savePair()">Save</button>
      <button class="secondary" onclick="closeModal()">Close</button>
    </div>

    <div id="pairList" class="pair-list"></div>
  </div>
</div>

<script>
// ================= FIREBASE =================
firebase.initializeApp({
  apiKey: "AIzaSyAnt7Ctex3Eom36UTt1PzkOw1vCSXNBEzk",
  authDomain: "lotcalci.firebaseapp.com",
  projectId: "lotcalci"
});
const db = firebase.firestore();
const FIRE_COLLECTION="cloudPairs";

// ================= DATA =================
let pairs={};
const LOCAL_KEY="fx_pairs_open";

// ================= LOAD =================
function loadLocal(){
  pairs = JSON.parse(localStorage.getItem(LOCAL_KEY) || "{}");
}
function saveLocal(){
  localStorage.setItem(LOCAL_KEY,JSON.stringify(pairs));
}
function populate(){
  const sel=document.getElementById("pairSelect");
  sel.innerHTML="";
  Object.keys(pairs).forEach(n=>{
    const o=document.createElement("option");
    o.value=n;o.textContent=n;
    sel.appendChild(o);
  });
  renderList();
}

// ================= CLOUD =================
function reloadCloud(){
  db.collection(FIRE_COLLECTION).get().then(snap=>{
    snap.forEach(d=>{
      pairs[d.id]={...d.data()};
    });
    saveLocal();populate();
  });
}

// ================= CALC =================
function calculateLot(){
  const p=pairs[pairSelect.value];
  if(!p)return;
  const risk=+riskInput.value||+risk.value;
  const slv=+sl.value;
  let v=0;
  switch(lotType.value){
    case "standardPoint":v=p.point;break;
    case "miniPoint":v=p.point/10;break;
    case "microPoint":v=p.point/100;break;
    case "standardPip":v=p.pip;break;
    case "miniPip":v=p.pip/10;break;
    case "microPip":v=p.pip/100;break;
  }
  const lot=risk/(slv*v+p.commission);
  lotResult.style.display="block";
  lotResult.innerText="Lot Size: "+lot.toFixed(2);
}
function clearCalc(){
  risk.value="";sl.value="";
  lotResult.style.display="none";
}

// ================= MODAL =================
function openModal(){
  modal.style.display="flex";
  renderList();
}
function closeModal(){
  modal.style.display="none";
}

// ================= PAIRS =================
function savePair(){
  const n=editName.value.toUpperCase();
  pairs[n]={
    point:+editPoint.value,
    pip:+editPip.value,
    commission:+editCommission.value
  };
  saveLocal();
  db.collection(FIRE_COLLECTION).doc(n).set(pairs[n]);
  populate();
}
function renderList(){
  const w=document.getElementById("pairList");
  w.innerHTML="";
  Object.keys(pairs).forEach(n=>{
    const d=document.createElement("div");
    d.className="pair-item";
    d.innerHTML=`<span>${n}</span>`;
    const b=document.createElement("button");
    b.className="small-btn";
    b.textContent="Delete";
    b.onclick=()=>{
      delete pairs[n];
      db.collection(FIRE_COLLECTION).doc(n).delete();
      saveLocal();populate();
    };
    d.appendChild(b);
    w.appendChild(d);
  });
}

// ================= INIT =================
loadLocal();
reloadCloud();
</script>

</body>
</html>
