<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>‚Çπ@‚ìñ$ ùï±‚úó ‚Äî Final</title>
<link rel="icon" type="image/png" href="icon.png">
<link rel="apple-touch-icon" href="icon.png">
<link rel="manifest" href="manifest.json">

<!-- Firebase scripts -->
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>

<style>
:root{--accent:#007bff;--bg:#f4f6fb;--card:#fff;--muted:#666}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);-webkit-font-smoothing:antialiased}
.wrap{max-width:720px;margin:48px auto;padding:12px}
.card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 8px 24px rgba(10,10,20,0.06)}
h1{text-align:center;font-size:20px;margin-bottom:12px}
label{display:block;margin-top:10px;font-weight:600;color:#222;font-size:14px}
select,input,button{width:100%;padding:10px;border-radius:8px;border:1px solid #d6dbe6;font-size:15px;margin-top:6px}
button{background:var(--accent);color:#fff;border:0;cursor:pointer}
button.secondary{background:#eee;color:#111}
.small{font-size:13px;color:#666;margin-top:8px}
.row{display:flex;gap:8px;margin-top:10px}
.row button{flex:1}
.pair-list{max-height:260px;overflow:auto;border:1px solid #eee;padding:8px;border-radius:8px;background:#fafafa;margin-top:8px}
.pair-item{display:flex;align-items:center;justify-content:space-between;padding:8px;border-bottom:1px solid #eee}
.pair-item:last-child{border-bottom:0}
.small-btn{padding:6px 8px;border-radius:6px;border:0;background:#eee;color:#111;cursor:pointer}
.modal{position:fixed;inset:0;display:none;align-items:flex-start;justify-content:center;background:rgba(0,0,0,0.55);z-index:9999;padding:12px;overflow-y:auto;}
.panel{background:#fff;padding:14px;border-radius:10px;max-height:90vh;overflow-y:auto;max-width:720px;width:100%}
#lotResult{margin-top:12px;text-align:center;font-weight:700;color:#06204a;font-size:18px;background:#e8f0ff;display:inline-block;padding:6px 12px;border-radius:8px;box-shadow:0 2px 6px rgba(10,20,60,0.06);}
@media(max-width:480px){.row{flex-direction:column}.row button{width:100%}}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>‚Çπ@‚ìñ$ ùï±‚úó</h1>

    <!-- Authentication Section -->
    <div id="authSection">
      <input id="email" type="email" placeholder="Email">
      <input id="password" type="password" placeholder="Password">
      <input id="confirmPassword" type="password" placeholder="Confirm Password" style="display:none">
      <div class="row" style="margin-top:10px">
        <button id="loginBtn">Login</button>
        <button id="signupBtn">Sign Up</button>
        <button id="createBtn" style="display:none">Create</button>
      </div>
      <button class="secondary" id="forgotBtn" style="margin-top:6px">Forgot Password?</button>
      <div id="authMsg" class="small"></div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminSection" style="display:none;margin-top:20px">
      <h3>Admin Dashboard</h3>
      <div id="userList" class="pair-list"></div>
    </div>

    <!-- Calculator Section -->
    <div id="calcSection" style="display:none">
      <label for="pairSelect">Pair</label>
      <select id="pairSelect"></select>
      <label for="lotType">Lot type / mode</label>
      <select id="lotType">
        <option value="standardPoint">Standard Point Value</option>
        <option value="miniPoint">Mini Point Value</option>
        <option value="microPoint">Micro Point Value</option>
        <option value="standardPip">Standard Pip Value</option>
        <option value="miniPip">Mini Pip Value</option>
        <option value="microPip">Micro Pip Value</option>
      </select>
      <label for="risk">Risk ($)</label>
      <input id="risk" type="number" placeholder="e.g. 30">
      <label for="sl">Stop-loss (points / pips)</label>
      <input id="sl" type="number" placeholder="e.g. 15">
      <div class="row">
        <button onclick="calculateLot()">Calculate Lot Size</button>
        <button class="secondary" onclick="clearCalc()">Clear</button>
      </div>
      <div id="lotResult" aria-live="polite" style="display:none"></div>
      <div class="row" style="margin-top:12px">
        <button class="secondary" onclick="openModal()">Add / Edit / Sync</button>
        <button class="secondary" id="logoutBtn" onclick="logout()">Logout</button>
        <button class="secondary" onclick="reloadCloud()">Reload Cloud</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Editor -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true">
    <h3>Add / Edit / Sync Pairs</h3>
    <div id="stepUnlock">
      <div class="small">Enter App Password</div>
      <input id="modalAppPw" type="password" placeholder="App password">
      <div class="row" style="margin-top:8px">
        <button onclick="unlockModal()">Continue</button>
        <button class="secondary" onclick="closeModal()">Close</button>
      </div>
      <div id="unlockErr" class="small" style="color:#b00020"></div>
    </div>
    <div id="editor" style="display:none;margin-top:12px">
      <label>Pair code (e.g. EURUSD)</label>
      <input id="editName" placeholder="PAIR (uppercase)">
      <label>Point value (1 standard lot)</label>
      <input id="editPoint" type="number" placeholder="point">
      <label>Pip value (1 standard lot)</label>
      <input id="editPip" type="number" placeholder="pip">
      <label>Commission ($ per 1 lot)</label>
      <input id="editCommission" type="number" placeholder="commission">
      <div class="row" style="margin-top:8px">
        <button onclick="saveLocalPair()">Save Local</button>
        <button class="secondary" onclick="openSyncArea()">Sync Cloud</button>
        <button class="secondary" onclick="openDeleteEdit()">Delete / Edit</button>
      </div>
      <div style="margin-top:8px">
        <button class="secondary" onclick="closeModal()">Close</button>
      </div>

      <!-- Sync area -->
      <div id="syncArea" style="display:none;margin-top:12px">
        <div class="small">Enter Cloud Password</div>
        <input id="cloudPw" type="password" placeholder="Cloud password">
        <div class="row" style="margin-top:8px">
          <button onclick="unlockCloudForSync()">Unlock Cloud</button>
          <button class="secondary" onclick="closeSyncArea()">Cancel</button>
        </div>
        <div id="syncListWrap" style="display:none;margin-top:10px">
          <div class="small">Select LOCAL pairs to push to cloud</div>
          <div id="syncList" class="pair-list"></div>
          <div class="row" style="margin-top:8px">
            <button onclick="pushSelectedToCloud()">Push Selected to Cloud</button>
            <button class="secondary" onclick="closeSyncArea()">Done</button>
          </div>
        </div>
      </div>

      <!-- Delete/Edit area -->
      <div id="deArea" style="display:none;margin-top:12px">
        <div class="small">Pairs (C = cloud, L = local)</div>
        <div id="deList" class="pair-list"></div>
        <div class="row" style="margin-top:8px">
          <button class="secondary" onclick="closeDeleteEdit()">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ================== Firebase Projects ==================

// Auth project
const authApp = firebase.initializeApp({
  apiKey: "AIzaSyBf-D1KYMJ_b3_1Dog7AkJ8b0MST0fD_9g",
  authDomain: "auth-9bef7.firebaseapp.com",
  projectId: "auth-9bef7",
  storageBucket: "auth-9bef7.firebasestorage.app",
  messagingSenderId: "27179558968",
  appId: "1:27179558968:web:cbc4c3b162ea2114c11ecd"
}, "authApp");
const auth = authApp.auth();
const authDb = authApp.firestore();

// Cloud project
const cloudApp = firebase.initializeApp({
  apiKey: "AIzaSyAnt7Ctex3Eom36UTt1PzkOw1vCSXNBEzk",
  authDomain: "lotcalci.firebaseapp.com",
  projectId: "lotcalci",
  storageBucket: "lotcalci.firebasestorage.app",
  messagingSenderId: "662389905318",
  appId: "1:662389905318:web:3b9963ab853374ee606167"
}, "cloudApp");
const db = cloudApp.firestore();

// ================== Global Vars ==================
const APP_PASSWORD = "6565";
const CLOUD_PASSWORD = "123456";
const LOCAL_KEY = "fx_pairs_v_final";
const FIRE_COLLECTION = "cloudPairs";
let pairs = {};
// ================== Authentication ==================
const emailEl = document.getElementById("email");
const passwordEl = document.getElementById("password");
const confirmEl = document.getElementById("confirmPassword");
const loginBtn = document.getElementById("loginBtn");
const signupBtn = document.getElementById("signupBtn");
const createBtn = document.getElementById("createBtn");
const forgotBtn = document.getElementById("forgotBtn");
const authMsg = document.getElementById("authMsg");

const authSection = document.getElementById("authSection");
const calcSection = document.getElementById("calcSection");
const adminSection = document.getElementById("adminSection");
const userListEl = document.getElementById("userList");

loginBtn.addEventListener("click", async () => {
    const email = emailEl.value.trim();
    const pw = passwordEl.value;
    if(!email || !pw){authMsg.innerText="Enter email & password";return;}
    try {
        const userCred = await auth.signInWithEmailAndPassword(email,pw);
        const userDoc = await authDb.collection("users").doc(userCred.user.uid).get();
        const data = userDoc.data();
        if(!data.approved){
            authMsg.innerText="Account not approved by admin";
            auth.signOut();
            return;
        }
        loadApp(userCred.user);
    } catch(e){
        authMsg.innerText=e.message;
    }
});

signupBtn.addEventListener("click", () => {
    confirmEl.style.display="block";
    loginBtn.style.display="none";
    signupBtn.style.display="none";
    createBtn.style.display="block";
});

createBtn.addEventListener("click", async () => {
    const email = emailEl.value.trim();
    const pw = passwordEl.value;
    const conf = confirmEl.value;
    if(pw!==conf){authMsg.innerText="Passwords do not match";return;}
    try {
        const userCred = await auth.createUserWithEmailAndPassword(email,pw);
        await authDb.collection("users").doc(userCred.user.uid).set({
            email,emailApproved:false,approved:false,role:"user"
        });
        authMsg.innerText="Account created, wait admin approval";
        confirmEl.style.display="none";
        loginBtn.style.display="block";
        signupBtn.style.display="block";
        createBtn.style.display="none";
    } catch(e){authMsg.innerText=e.message;}
});

forgotBtn.addEventListener("click", async () => {
    const email = emailEl.value.trim();
    if(!email){authMsg.innerText="Enter email to reset";return;}
    try{
        await auth.sendPasswordResetEmail(email);
        authMsg.innerText="Password reset email sent";
    }catch(e){authMsg.innerText=e.message;}
});

async function loadApp(user){
    authSection.style.display="none";
    calcSection.style.display="block";
    const userDoc = await authDb.collection("users").doc(user.uid).get();
    if(userDoc.data().role==="admin"){
        adminSection.style.display="block";
        loadAdminList();
    }
    loadLocalPairs();
    populateDropdown();
}

// ================== Admin Dashboard ==================
async function loadAdminList(){
    const snapshot = await authDb.collection("users").get();
    userListEl.innerHTML="";
    snapshot.forEach(doc=>{
        const data = doc.data();
        if(data.approved) return;
        const div = document.createElement("div");
        div.className="pair-item";
        div.innerHTML=`<span>${data.email}</span><div>
            <button class="small-btn" onclick="approveUser('${doc.id}')">Approve</button>
            <button class="small-btn" onclick="rejectUser('${doc.id}')">Reject</button>
        </div>`;
        userListEl.appendChild(div);
    });
}

async function approveUser(uid){
    await authDb.collection("users").doc(uid).update({approved:true});
    loadAdminList();
}
async function rejectUser(uid){
    await authDb.collection("users").doc(uid).delete();
    loadAdminList();
}

// ================== Calculator Functions ==================
const pairSelect = document.getElementById("pairSelect");
const lotTypeEl = document.getElementById("lotType");
const riskEl = document.getElementById("risk");
const slEl = document.getElementById("sl");
const lotResultEl = document.getElementById("lotResult");

function loadLocalPairs(){
    const stored = localStorage.getItem(LOCAL_KEY);
    if(stored){pairs = JSON.parse(stored);}
}

function saveLocalPairs(){
    localStorage.setItem(LOCAL_KEY, JSON.stringify(pairs));
}

function populateDropdown(){
    pairSelect.innerHTML="";
    for(let key in pairs){
        const opt = document.createElement("option");
        opt.value=key;
        opt.innerText=key;
        pairSelect.appendChild(opt);
    }
}

function calculateLot(){
    const pair = pairSelect.value;
    const type = lotTypeEl.value;
    const risk = parseFloat(riskEl.value);
    const sl = parseFloat(slEl.value);
    if(!pair || !pairs[pair] || isNaN(risk) || isNaN(sl)){lotResultEl.style.display="none"; return;}
    let val=0;
    const data = pairs[pair];
    switch(type){
        case "standardPoint": val=data.point; break;
        case "miniPoint": val=data.point/10; break;
        case "microPoint": val=data.point/100; break;
        case "standardPip": val=data.pip; break;
        case "miniPip": val=data.pip/10; break;
        case "microPip": val=data.pip/100; break;
    }
    const lot = (risk/(sl*val)).toFixed(2);
    lotResultEl.innerText=`Lot size: ${lot}`;
    lotResultEl.style.display="inline-block";
}

function clearCalc(){
    riskEl.value="";
    slEl.value="";
    lotResultEl.style.display="none";
}

// ================== Logout ==================
function logout(){
    auth.signOut();
    authSection.style.display="block";
    calcSection.style.display="none";
    adminSection.style.display="none";
    emailEl.value=""; passwordEl.value=""; confirmEl.value="";
}
// ================== Modal & Editor ==================
const modal = document.getElementById("modal");
const stepUnlock = document.getElementById("stepUnlock");
const editor = document.getElementById("editor");
const modalAppPw = document.getElementById("modalAppPw");
const unlockErr = document.getElementById("unlockErr");
const editName = document.getElementById("editName");
const editPoint = document.getElementById("editPoint");
const editPip = document.getElementById("editPip");
const editCommission = document.getElementById("editCommission");
const syncArea = document.getElementById("syncArea");
const cloudPw = document.getElementById("cloudPw");
const syncListWrap = document.getElementById("syncListWrap");
const syncList = document.getElementById("syncList");
const deArea = document.getElementById("deArea");
const deList = document.getElementById("deList");

let cloudUnlocked = false;

function openModal(){
    modal.style.display="flex";
    stepUnlock.style.display="block";
    editor.style.display="none";
    unlockErr.innerText="";
    modalAppPw.value="";
    populateDropdown();
}

function closeModal(){
    modal.style.display="none";
    closeSyncArea();
    closeDeleteEdit();
}

function unlockModal(){
    const pw = modalAppPw.value.trim();
    if(pw===APP_PASSWORD){
        stepUnlock.style.display="none";
        editor.style.display="block";
        const sel = pairSelect.value;
        if(pairs[sel]){
            editName.value = sel;
            editPoint.value = pairs[sel].point;
            editPip.value = pairs[sel].pip;
            editCommission.value = pairs[sel].commission;
        } else {
            editName.value=""; editPoint.value=""; editPip.value=""; editCommission.value="";
        }
    } else {
        unlockErr.innerText="Wrong app password.";
    }
}

// ================== Save Local Pair ==================
function saveLocalPair(){
    const name = editName.value.trim().toUpperCase();
    const point = parseFloat(editPoint.value);
    const pip = parseFloat(editPip.value);
    const commission = parseFloat(editCommission.value);
    if(!name || isNaN(point) || isNaN(pip) || isNaN(commission)){alert("Fill all fields");return;}
    pairs[name]={point,pip,commission,type:"local"};
    saveLocalPairs();
    populateDropdown();
    alert(name + " saved locally");
}

// ================== Cloud Sync ==================
function openSyncArea(){
    cloudUnlocked=false;
    syncArea.style.display="block";
    cloudPw.value="";
    syncListWrap.style.display="none";
    populateLocalSyncList();
}

function closeSyncArea(){
    syncArea.style.display="none";
    syncList.innerHTML="";
    syncListWrap.style.display="none";
    cloudUnlocked=false;
}

function populateLocalSyncList(){
    syncList.innerHTML="";
    Object.keys(pairs).forEach(name=>{
        if(pairs[name].type==="local"){
            const item = document.createElement("div"); item.className="pair-item";
            const cb = document.createElement("input"); cb.type="checkbox"; cb.value=name;
            const lbl = document.createElement("div"); lbl.innerText=name;
            item.appendChild(cb); item.appendChild(lbl);
            syncList.appendChild(item);
        }
    });
}

function unlockCloudForSync(){
    if(cloudPw.value.trim()===CLOUD_PASSWORD){
        cloudUnlocked=true;
        syncListWrap.style.display="block";
    } else {
        alert("Wrong cloud password");
    }
}

async function pushSelectedToCloud(){
    if(!cloudUnlocked){alert("Unlock cloud first"); return;}
    const checks = Array.from(syncList.querySelectorAll("input[type=checkbox]:checked")).map(cb=>cb.value);
    if(checks.length===0){alert("Select pairs to sync"); return;}
    try{
        for(const name of checks){
            const p = pairs[name];
            await db.collection(FIRE_COLLECTION).doc(name).set({point:p.point,pip:p.pip,commission:p.commission});
            pairs[name].type="cloud";
        }
        saveLocalPairs();
        populateDropdown();
        alert("Synced: "+checks.join(", "));
        closeSyncArea();
    }catch(e){alert("Sync failed: "+e.message);}
}

// ================== Delete/Edit ==================
function openDeleteEdit(){
    deList.innerHTML="";
    Object.keys(pairs).forEach(name=>{
        const p = pairs[name];
        const item = document.createElement("div"); item.className="pair-item";
        const left = document.createElement("div"); left.innerText=name + " (" + (p.type==="cloud"?"C":"L") + ")";
        const right = document.createElement("div"); right.style.display="flex"; right.style.gap="6px";

        const topBtn = document.createElement("button"); topBtn.className="small-btn"; topBtn.innerText="‚Üë Top"; topBtn.onclick=()=>movePair(name,"top");
        const bottomBtn = document.createElement("button"); bottomBtn.className="small-btn"; bottomBtn.innerText="‚Üì Bottom"; bottomBtn.onclick=()=>movePair(name,"bottom");
        const editBtn = document.createElement("button"); editBtn.className="small-btn"; editBtn.innerText="Edit"; editBtn.onclick=()=>editFromList(name);
        const delBtn = document.createElement("button"); delBtn.className="small-btn"; delBtn.innerText="Delete"; delBtn.onclick=()=>deleteFromList(name);

        right.append(topBtn,bottomBtn,editBtn,delBtn);
        item.append(left,right);
        deList.appendChild(item);
    });
    deArea.style.display="block";
}

function closeDeleteEdit(){deArea.style.display="none";}

function movePair(name, where){
    const orders = Object.values(pairs).map(p=>p.order).filter(o=>typeof o==="number");
    const min = orders.length?Math.min(...orders):0;
    const max = orders.length?Math.max(...orders):0;
    if(where==="top") pairs[name].order=min-1;
    if(where==="bottom") pairs[name].order=max+1;
    saveLocalPairs();
    populateDropdown();
    openDeleteEdit();
    if(pairs[name].type==="cloud"){
        db.collection(FIRE_COLLECTION).doc(name).update({order:pairs[name].order}).catch(()=>{});
    }
}

function editFromList(name){
    const p = pairs[name]; if(!p) return;
    if(p.type==="cloud"){
        const pw = prompt("Enter cloud password to edit cloud pair:");
        if(pw!==CLOUD_PASSWORD){alert("Wrong cloud password"); return;}
    }
    editName.value=name; editPoint.value=p.point; editPip.value=p.pip; editCommission.value=p.commission;
    editor.style.display="block"; stepUnlock.style.display="none";
}

async function deleteFromList(name){
    const p = pairs[name]; if(!p) return;
    if(p.type==="cloud"){
        const pw = prompt("Enter cloud password to delete cloud pair:");
        if(pw!==CLOUD_PASSWORD){alert("Wrong cloud password"); return;}
        await db.collection(FIRE_COLLECTION).doc(name).delete().catch(()=>{});
    }
    delete pairs[name];
    saveLocalPairs();
    populateDropdown();
    openDeleteEdit();
}

// ================== Cloud reload ==================
async function reloadCloud(){
    try{
        await db.collection(FIRE_COLLECTION).get();
        alert("Cloud fetch requested, dropdown will update shortly");
    }catch(e){alert("Cloud reload failed: "+e.message);}
}

// ================== Cloud Listener ==================
function startCloudListener(){
    db.collection(FIRE_COLLECTION).onSnapshot(snapshot=>{
        snapshot.forEach(doc=>{
            const name=doc.id; const data=doc.data();
            pairs[name]={point:data.point??0,pip:data.pip??0,commission:data.commission??0,type:"cloud"};
        });
        populateDropdown();
        saveLocalPairs();
    });
}

startCloudListener();
