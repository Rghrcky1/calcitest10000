<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>‚Çπ@‚ìñ$ ùï±‚úó ‚Äî Final</title>

<link rel="icon" type="image/png" href="icon.png">
<link rel="apple-touch-icon" href="icon.png">
<link rel="manifest" href="manifest.json">

<!-- Firebase scripts -->
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>

<style>
:root{--accent:#007bff;--bg:#f4f6fb;--card:#fff;--muted:#666}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg)}
.wrap{max-width:720px;margin:48px auto;padding:12px}
.card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 8px 24px rgba(10,10,20,0.06)}
h1{text-align:center;font-size:20px;margin-bottom:12px}
label{display:block;margin-top:10px;font-weight:600;color:#222;font-size:14px}
select,input,button{width:100%;padding:10px;border-radius:8px;border:1px solid #d6dbe6;font-size:15px;margin-top:6px}
button{background:var(--accent);color:#fff;border:0;cursor:pointer}
button.secondary{background:#eee;color:#111}
.small{font-size:13px;color:#666;margin-top:8px}
.row{display:flex;gap:8px;margin-top:10px}
.row button{flex:1}
.pair-list{max-height:260px;overflow:auto;border:1px solid #eee;padding:8px;border-radius:8px;background:#fafafa;margin-top:8px}
.pair-item{display:flex;align-items:center;justify-content:space-between;padding:8px;border-bottom:1px solid #eee}
.pair-item:last-child{border-bottom:0}
.small-btn{padding:3px 6px;border-radius:6px;border:0;background:#eee;color:#111;cursor:pointer;font-size:12px;margin-left:4px}
.modal{position:fixed;inset:0;display:none;align-items:flex-start;justify-content:center;background:rgba(0,0,0,0.55);z-index:9999;padding:12px;overflow-y:auto;}
.panel{background:#fff;padding:14px;border-radius:10px;max-height:90vh;overflow-y:auto;max-width:720px;width:100%}
#lotResult{margin-top:12px;text-align:center;font-weight:700;color:#06204a;font-size:18px;background:#e8f0ff;display:inline-block;padding:6px 12px;border-radius:8px}
@media(max-width:480px){.row{flex-direction:column}}
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>‚Çπ@‚ìñ$ ùï±‚úóz</h1>

    <!-- AUTH -->
    <div id="authSection">
      <input id="email" type="email" placeholder="Email">
      <input id="password" type="password" placeholder="Password">
      <input id="confirmPassword" type="password" placeholder="Confirm Password" style="display:none">
      <div class="row">
        <button id="loginBtn">Login</button>
        <button id="signupBtn">Sign Up</button>
        <button id="createBtn" style="display:none">Create</button>
      </div>
      <button class="secondary" id="forgotBtn">Forgot Password?</button>
      <div id="authMsg" class="small"></div>
    </div>

    <!-- ADMIN -->
    <div id="adminSection" style="display:none;margin-top:20px">
      <h3>Admin Dashboard</h3>
      <div id="userList" class="pair-list"></div>
      <h3>Audit Log</h3>
      <div id="auditList" class="pair-list"></div>
      <h4>Device Change Requests</h4>
      <div id="deviceReqList" class="pair-list"></div>
    </div>

    <!-- CALCULATOR -->
    <div id="calcSection" style="display:none; pointer-events:none; opacity:0.5">
      <!-- calculator content continues in next part -->
    </div>

  </div>
</div>

<!-- PART 1 END -->
<!-- CALCULATOR CONTENT -->
<div id="calcSection" style="display:none; pointer-events:none; opacity:0.5">
  <label for="pairSelect">Pair</label>
  <select id="pairSelect"></select>

  <label for="lotType">Lot type / mode</label>
  <select id="lotType">
    <option value="standardPoint">Standard Point Value</option>
    <option value="miniPoint">Mini Point Value</option>
    <option value="microPoint">Micro Point Value</option>
    <option value="standardPip">Standard Pip Value</option>
    <option value="miniPip">Mini Pip Value</option>
    <option value="microPip">Micro Pip Value</option>
  </select>

  <label for="risk">Risk ($)</label>
  <input id="risk" type="number">

  <label for="sl">Stop-loss (points / pips)</label>
  <input id="sl" type="number">

  <div class="row">
    <button onclick="calculateLot()">Calculate Lot Size</button>
    <button class="secondary" onclick="clearCalc()">Clear</button>
  </div>

  <div id="lotResult" style="display:none"></div>

  <div class="row" style="margin-top:12px">
    <button class="secondary" onclick="openModal()">Add / Edit / Sync</button>
    <button class="secondary" id="logoutBtn">Logout</button>
    <button class="secondary" onclick="reloadCloud()">Reload Cloud</button>
  </div>
</div>

<!-- MODAL -->
<div id="modal" class="modal">
  <div class="panel">
    <h3>Add / Edit / Sync Pairs</h3>
    <div id="editor"></div>
    <button class="secondary" onclick="closeModal()">Close</button>
  </div>
</div>

<script>
// ===================== FIREBASE INIT =====================

// AUTH PROJECT
const authApp = firebase.initializeApp({
  apiKey: "AIzaSyBf-D1KYMJ_b3_1Dog7AkJ8b0MST0fD_9g",
  authDomain: "auth-9bef7.firebaseapp.com",
  projectId: "auth-9bef7"
}, "authApp");

const auth = authApp.auth();
const authDb = authApp.firestore();

// CLOUD PROJECT
const cloudApp = firebase.initializeApp({
  apiKey: "AIzaSyAnt7Ctex3Eom36UTt1PzkOw1vCSXNBEzk",
  authDomain: "lotcalci.firebaseapp.com",
  projectId: "lotcalci"
}, "cloudApp");

const db = cloudApp.firestore();

// ===================== GLOBAL VARS =====================
const CLOUD_PASSWORD = "123456";
const LOCAL_KEY = "fx_pairs_v_final";
const FIRE_COLLECTION = "cloudPairs";
let pairs = {};
let USER_APPROVED = false;

// ===================== DEVICE ID =====================
function getDeviceId(){
  let id = localStorage.getItem("DEVICE_ID");
  if(!id){
    id = "dev_" + Math.random().toString(36).substr(2) + Date.now();
    localStorage.setItem("DEVICE_ID", id);
  }
  return id;
}
const DEVICE_ID = getDeviceId();

<!-- PART 2 END -->
// ===================== LOAD / SAVE PAIRS =====================
const defaultPairs = {};

function loadLocalPairs(){
  const raw = localStorage.getItem(LOCAL_KEY);
  const saved = raw ? JSON.parse(raw) : {};
  pairs = JSON.parse(JSON.stringify(defaultPairs));
  Object.keys(saved).forEach(k=>pairs[k]=saved[k]);
}

function saveLocalPairs(){
  localStorage.setItem(LOCAL_KEY, JSON.stringify(pairs));
}

function populateDropdown(){
  const sel=document.getElementById('pairSelect');
  if(!sel) return;
  sel.innerHTML='';
  const list=Object.keys(pairs).map(name=>({name,order:typeof pairs[name].order==='number'?pairs[name].order:null}));
  list.sort((a,b)=>{
    if(a.order!==null&&b.order!==null) return a.order-b.order;
    if(a.order!==null) return -1;
    if(b.order!==null) return 1;
    return a.name.localeCompare(b.name);
  });
  list.forEach(({name})=>{
    const opt=document.createElement('option');
    opt.value=name;
    opt.text=pairs[name].type==='cloud'?`${name} (C)`:`${name} (L)`;
    sel.appendChild(opt);
  });
}

// ===================== CLOUD LISTENER =====================
let unsubscribeSnapshot = null;
function startCloudListener(){
  if(unsubscribeSnapshot) unsubscribeSnapshot();
  unsubscribeSnapshot=db.collection(FIRE_COLLECTION).onSnapshot(snapshot=>{
    snapshot.forEach(doc=>{
      const name=doc.id;
      const data=doc.data();
      const local=pairs[name];
      pairs[name]={
        point:data.point ?? (local?local.point:0),
        pip:data.pip ?? (local?local.pip:0),
        commission:(local&&local.commission!==undefined)?local.commission:(data.commission??0),
        order:typeof data.order==='number'?data.order:(local&&typeof local.order==='number'?local.order:null),
        type:'cloud'
      };
    });
    const cloudIds=new Set(snapshot.docs.map(d=>d.id));
    Object.keys(pairs).forEach(k=>{
      if(pairs[k].type==='cloud'&&!cloudIds.has(k)){
        if(defaultPairs[k]) pairs[k]=JSON.parse(JSON.stringify(defaultPairs[k]));
        else delete pairs[k];
      }
    });
    saveLocalPairs();
    populateDropdown();
  });
}

// ===================== CALCULATOR =====================
function calculateLot(){
  if(!USER_APPROVED){alert("Waiting for admin approval");return;}

  const name=document.getElementById('pairSelect').value;
  const lotType=document.getElementById('lotType').value;
  const risk=parseFloat(document.getElementById('risk').value);
  const sl=parseFloat(document.getElementById('sl').value);

  if(!name||isNaN(risk)||isNaN(sl)||risk<=0||sl<=0){
    document.getElementById('lotResult').style.display='none';
    return;
  }

  const p=pairs[name];
  if(!p){document.getElementById('lotResult').style.display='none';return;}

  const comm=Number(p.commission||0);
  let v=0;

  switch(lotType){
    case "standardPoint": v=p.point; break;
    case "miniPoint": v=p.point/10; break;
    case "microPoint": v=p.point/100; break;
    case "standardPip": v=p.pip; break;
    case "miniPip": v=p.pip/10; break;
    case "microPip": v=p.pip/100; break;
  }

  const lot=risk/(sl*v+comm);
  const amt=lot*sl*v, comAmt=lot*comm, total=amt+comAmt;

  const el=document.getElementById('lotResult');
  el.innerHTML=`LotSize = ${lot.toFixed(2)} | Total = ${total.toFixed(2)}`;
  el.style.display='block';
}

function clearCalc(){
  document.getElementById('risk').value='';
  document.getElementById('sl').value='';
  document.getElementById('lotResult').style.display='none';
}

// ===================== MODAL =====================
function openModal(){document.getElementById('modal').style.display='flex';}
function closeModal(){document.getElementById('modal').style.display='none';}

// ===================== RELOAD CLOUD =====================
function reloadCloud(){startCloudListener();}

<!-- PART 3 END -->
// ===================== LOGIN / SIGNUP / LOGOUT =====================
function login(){
  const e=document.getElementById('email').value.trim();
  const p=document.getElementById('password').value;
  auth.signInWithEmailAndPassword(e,p)
    .catch(err=>document.getElementById('authMsg').innerText=err.message);
}

function signup(){
  document.getElementById('confirmPassword').style.display='block';
  document.getElementById('createBtn').style.display='inline-block';
  document.getElementById('signupBtn').style.display='none';
}

function create(){
  const e=document.getElementById('email').value.trim();
  const p=document.getElementById('password').value;
  const cp=document.getElementById('confirmPassword').value;

  if(p!==cp){
    document.getElementById('authMsg').innerText="Passwords do not match";
    return;
  }

  auth.createUserWithEmailAndPassword(e,p)
    .then(cred=>{
      cred.user.sendEmailVerification();
      return authDb.collection("users").doc(cred.user.uid).set({
        email:e,
        approved:false,
        emailVerified:false,
        role:"user",
        createdAt:firebase.firestore.FieldValue.serverTimestamp()
      });
    })
    .then(()=>{
      document.getElementById('authMsg').innerText =
        "Verify email first. Then wait for admin approval.";
      auth.signOut();
    })
    .catch(err=>document.getElementById('authMsg').innerText=err.message);
}

function logout(){
  auth.signOut();
}

// ===================== ADMIN =====================
function loadPendingUsers(){
  const list=document.getElementById('userList');
  list.innerHTML="Loading...";
  authDb.collection("users")
    .where("approved","==",false)
    .where("emailVerified","==",true)
    .get()
    .then(snap=>{
      list.innerHTML="";
      if(snap.empty){
        list.innerHTML="<div class='small'>No pending users</div>";
        return;
      }
      snap.forEach(doc=>{
        const div=document.createElement("div");
        div.className="pair-item";
        div.innerHTML=`
          <span>${doc.data().email}</span>
          <button class="small-btn" onclick="approveUser('${doc.id}')">Approve</button>
        `;
        list.appendChild(div);
      });
    });
}

function loadDeviceRequests(){
  const list=document.getElementById('deviceReqList');
  list.innerHTML="Loading...";
  authDb.collection("users")
    .where("deviceChangeReq","==",true)
    .get()
    .then(snap=>{
      list.innerHTML="";
      snap.forEach(doc=>{
        const div=document.createElement("div");
        div.className="pair-item";
        div.innerHTML=`
          <span>${doc.data().email}</span>
          <button class="small-btn" onclick="approveDevice('${doc.id}')">Approve Device</button>
        `;
        list.appendChild(div);
      });
    });
}

function approveUser(uid){
  authDb.collection("users").doc(uid).update({approved:true})
    .then(()=>loadPendingUsers());
}

function approveDevice(uid){
  const ref=authDb.collection("users").doc(uid);
  ref.get().then(doc=>{
    if(!doc.exists) return;
    const newDev=doc.data().requestedDeviceId;
    ref.update({
      deviceId:newDev,
      deviceChangeReq:firebase.firestore.FieldValue.delete(),
      requestedDeviceId:firebase.firestore.FieldValue.delete()
    }).then(()=>loadDeviceRequests());
  });
}

// ===================== AUTH STATE LISTENER (FIXED) =====================
auth.onAuthStateChanged(user=>{
  if(!user){
    document.getElementById('authSection').style.display='block';
    document.getElementById('calcSection').style.display='none';
    USER_APPROVED=false;
    return;
  }

  user.reload().then(()=>{
    if(!user.emailVerified){
      alert("Please verify your email first.");
      auth.signOut();
      return;
    }

    const ref=authDb.collection("users").doc(user.uid);

    ref.get().then(doc=>{
      if(!doc.exists) return;
      const d=doc.data();

      if(d.emailVerified!==true){
        ref.update({emailVerified:true});
      }

      if(d.approved!==true){
        alert("Waiting for admin approval.");
        auth.signOut();
        return;
      }

      // üîê ONE DEVICE ONLY
      if(d.deviceId && d.deviceId!==DEVICE_ID){
        if(!d.deviceChangeReq){
          ref.update({
            deviceChangeReq:true,
            requestedDeviceId:DEVICE_ID
          });
        }
        alert("New device detected. Waiting for admin approval.");
        auth.signOut();
        return;
      }

      // SAVE DEVICE ONLY FIRST TIME / AFTER APPROVAL
      if(!d.deviceId){
        ref.update({deviceId:DEVICE_ID});
      }

      // ‚úÖ LOGIN SUCCESS
      USER_APPROVED=true;
      document.getElementById('authSection').style.display='none';
      document.getElementById('calcSection').style.display='block';
      document.getElementById('calcSection').style.pointerEvents="auto";
      document.getElementById('calcSection').style.opacity="1";

      if(d.role==="admin"){
        document.getElementById('adminSection').style.display='block';
        loadPendingUsers();
        loadDeviceRequests();
      } else {
        document.getElementById('adminSection').style.display='none';
      }

      loadLocalPairs();
      populateDropdown();
      startCloudListener();

      // üîÅ LIVE KICKOUT
      ref.onSnapshot(snap=>{
        if(!snap.exists) return;
        if(snap.data().deviceId!==DEVICE_ID){
          alert("Logged out because this account was used on another device.");
          auth.signOut();
        }
      });
    });
  });
});

// ===================== EVENTS =====================
document.getElementById('loginBtn').onclick=login;
document.getElementById('signupBtn').onclick=signup;
document.getElementById('createBtn').onclick=create;
document.getElementById('logoutBtn').onclick=logout;
</script>
</body>
</html>
